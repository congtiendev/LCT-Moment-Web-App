// Prisma Schema for Locket Web App
// Database: PostgreSQL
// Version: 1.0.0

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum AuthProvider {
  email
  google
}

enum FriendRequestStatus {
  pending
  accepted
  rejected
}

enum NotificationType {
  friend_request
  friend_accepted
  photo_uploaded
  reaction
  photo_view
  message
}

enum UserRole {
  USER
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

// ==================== MODELS ====================

// 1. USERS TABLE (extended columns)
model User {
  id            String        @id @default(uuid())
  email         String        @unique
  password      String?       // Nullable for Google OAuth
  name          String
  username      String?       @unique
  avatar        String?
  bio           String?
  role          UserRole      @default(USER)
  phone         String?
  status        UserStatus    @default(ACTIVE)
  emailVerified Boolean       @default(false) @map("email_verified")
  provider      AuthProvider  @default(email)
  googleId      String?       @unique @map("google_id")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  lastLoginAt   DateTime?     @map("last_login_at")

  // Relations
  settings                UserSettings?
  photos                  Photo[]
  photoReactions          PhotoReaction[]
  photoViews              PhotoView[]
  friendships             Friendship[]     @relation("UserFriendships")
  friendsOf               Friendship[]     @relation("FriendOfUser")
  sentRequests            FriendRequest[]  @relation("SentRequests")
  receivedRequests        FriendRequest[]  @relation("ReceivedRequests")
  sentChats               Chat[]           @relation("SentChats")
  receivedChats           Chat[]           @relation("ReceivedChats")
  notifications           Notification[]
  relatedNotifications    Notification[]   @relation("NotificationRelatedUser")
  refreshTokens           RefreshToken[]

  @@index([email])
  @@index([username])
  @@index([googleId])
  @@map("users")
}

// 2. USER SETTINGS TABLE
model UserSettings {
  id        String   @id @default(uuid())
  userId    String   @unique @map("user_id")

  // General settings
  notificationsEnabled Boolean @default(true) @map("notifications_enabled")
  soundEnabled         Boolean @default(true) @map("sound_enabled")
  autoSavePhotos       Boolean @default(false) @map("auto_save_photos")
  photoQuality         String  @default("high") @map("photo_quality") // high, medium, low
  theme                String  @default("system") // system, light, dark
  language             String  @default("vi") // vi, en

  // Privacy settings
  isPrivate           Boolean @default(false) @map("is_private")
  allowPhotosFrom     String  @default("friends_only") @map("allow_photos_from") // everyone, friends_only, none
  hideFromSuggestions Boolean @default(false) @map("hide_from_suggestions")
  allowFriendPhotos   Boolean @default(true) @map("allow_friend_photos")

  // Notification preferences
  notifyFriendRequest Boolean @default(true) @map("notify_friend_request")
  notifyPhotoUploaded Boolean @default(true) @map("notify_photo_uploaded")
  notifyReaction      Boolean @default(true) @map("notify_reaction")
  notifyMessage       Boolean @default(true) @map("notify_message")
  notifyEmail         Boolean @default(false) @map("notify_email")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}

// 3. PHOTOS TABLE (11 columns)
model Photo {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  imageUrl  String   @map("image_url")
  caption   String?

  // Metadata
  width     Int?
  height    Int?
  fileSize  Int?     @map("file_size")
  mimeType  String?  @map("mime_type")

  isPublic  Boolean  @default(true) @map("is_public")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  expiresAt DateTime? @map("expires_at")

  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  reactions PhotoReaction[]
  views     PhotoView[]

  @@index([userId])
  @@index([createdAt])
  @@map("photos")
}

// 4. PHOTO REACTIONS TABLE (5 columns)
model PhotoReaction {
  id        String   @id @default(uuid())
  photoId   String   @map("photo_id")
  userId    String   @map("user_id")
  emoji     String
  createdAt DateTime @default(now()) @map("created_at")

  photo Photo @relation(fields: [photoId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([photoId, userId]) // 1 reaction per user per photo
  @@index([photoId])
  @@index([userId])
  @@map("photo_reactions")
}

// 5. PHOTO VIEWS TABLE (4 columns)
model PhotoView {
  id        String   @id @default(uuid())
  photoId   String   @map("photo_id")
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  photo Photo @relation(fields: [photoId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([photoId, userId]) // Track unique views per user
  @@index([photoId])
  @@index([userId])
  @@map("photo_views")
}

// 6. FRIENDSHIPS TABLE (7 columns)
model Friendship {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  friendId   String   @map("friend_id")
  isFavorite Boolean  @default(false) @map("is_favorite")
  nickname   String?
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  user   User @relation("UserFriendships", fields: [userId], references: [id], onDelete: Cascade)
  friend User @relation("FriendOfUser", fields: [friendId], references: [id], onDelete: Cascade)

  @@unique([userId, friendId]) // No duplicates
  @@index([userId])
  @@index([friendId])
  @@map("friendships")
}

// 6. FRIEND REQUESTS TABLE (7 columns)
model FriendRequest {
  id          String              @id @default(uuid())
  senderId    String              @map("sender_id")
  receiverId  String              @map("receiver_id")
  status      FriendRequestStatus @default(pending)
  message     String?
  createdAt   DateTime            @default(now()) @map("created_at")
  updatedAt   DateTime            @updatedAt @map("updated_at")
  respondedAt DateTime?           @map("responded_at")

  sender   User @relation("SentRequests", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("ReceivedRequests", fields: [receiverId], references: [id], onDelete: Cascade)

  @@unique([senderId, receiverId]) // No duplicates
  @@index([senderId])
  @@index([receiverId])
  @@index([status])
  @@map("friend_requests")
}

// 7. CHATS TABLE (9 columns)
model Chat {
  id         String    @id @default(uuid())
  senderId   String    @map("sender_id")
  receiverId String    @map("receiver_id")
  message    String?
  imageUrl   String?   @map("image_url")
  isRead     Boolean   @default(false) @map("is_read")
  readAt     DateTime? @map("read_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  sender   User @relation("SentChats", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("ReceivedChats", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([senderId])
  @@index([receiverId])
  @@index([createdAt])
  @@map("chats")
}

// 8. NOTIFICATIONS TABLE (14 columns)
model Notification {
  id             String           @id @default(uuid())
  userId         String           @map("user_id")
  type           NotificationType
  title          String
  message        String?
  data           Json?            @map("data") // Flexible data field
  relatedUserId  String?          @map("related_user_id") // User who triggered the notification
  relatedItemId  String?          @map("related_item_id") // Related item (photo, friend request, etc.)
  imageUrl       String?          @map("image_url")
  actionUrl      String?          @map("action_url")
  isRead         Boolean          @default(false) @map("is_read")
  readAt         DateTime?        @map("read_at")
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")

  user        User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  relatedUser User? @relation("NotificationRelatedUser", fields: [relatedUserId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([relatedUserId])
  @@index([type])
  @@index([isRead])
  @@map("notifications")
}

// 9. REFRESH TOKENS TABLE (12 columns)
model RefreshToken {
  id         String    @id @default(uuid())
  userId     String    @map("user_id")
  token      String    @unique
  expiresAt  DateTime  @map("expires_at")

  // Device info
  deviceId   String?   @map("device_id")
  deviceName String?   @map("device_name")
  ipAddress  String?   @map("ip_address")
  userAgent  String?   @map("user_agent")

  isRevoked  Boolean   @default(false) @map("is_revoked")
  revokedAt  DateTime? @map("revoked_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}
